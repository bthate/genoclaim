#!/usr/bin/python3 -u
# GENOCLAIM - https://genoclaim.rtfd.io - OTP-CR-117/19/001 - otp.informationdesk@icc-cpi.int
#
#

import os

from bot.spc import cfg, check, cmd, execute, get_kernel, root

k = get_kernel()

txt="""[Unit]
Description=GENOCLAIM - https://genoclaim.rtfd.io - OTP-CR-117/19/001 - otp.informationdesk@icc-cpi.in
After=network-online.target
Wants=network-online.target

[Service]
ExecStart=/usr/local/bin/genoclaimd

[Install]
WantedBy=multi-user.target
"""

def hup(event):
    if not root():
        event.reply("you need root permission.")
        return
    for x in os.popen("service genoclaim stop").readlines():
        print(x.rstrip())
    for x in os.popen("service genoclaim start").readlines():
        print(x.rstrip())
    for x in os.popen("systemctl status genoclaim --no-pager").readlines():
        print(x.rstrip())
    event.reply("ok")

def install(event):
    if not root():
        event.reply("you need root permission.")
        return
    f = open("/etc/systemd/system/genoclaim.service", "w")
    f.write(txt)
    f.close()
    os.popen("systemctl enable genoclaim")
    os.popen("systemctl daemon-reload")
    event.reply("ok")

def remove(event):
    if not root():
        event.reply("you need root permission.")
        return
    p = "/etc/systemd/system/genoclaim.service"
    if os.path.exists(p):
        for l in os.popen("rm %s" % p).readlines():
            print(l) 
    event.reply("ok")

def main():
    check("genoclaim")
    if root():
        k.cmds.register("hup", hup)
        k.cmds.register("install", install)
        k.cmds.register("remove", remove)
    k.scan("bot,genoclaim")
    cmd(cfg.txt)
       
execute(main)
